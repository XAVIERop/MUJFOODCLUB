<!DOCTYPE html>
<html>
<head>
    <title>Debug POS Orders</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Debug POS Orders</h1>
    
    <div class="debug-section info">
        <h3>üîç Debug POS Dashboard Order Display</h3>
        <p>This page helps debug why the POS dashboard shows "No orders found" despite having orders in the database.</p>
    </div>

    <div class="debug-section">
        <h3>1. Check All Cafes</h3>
        <button onclick="checkAllCafes()">Get All Cafes</button>
        <div id="cafesResult" class="log"></div>
    </div>

    <div class="debug-section">
        <h3>2. Check All Orders</h3>
        <button onclick="checkAllOrders()">Get All Orders</button>
        <div id="ordersResult" class="log"></div>
    </div>

    <div class="debug-section">
        <h3>3. Check Chatkara Specifically</h3>
        <button onclick="checkChatkaraOrders()">Get Chatkara Orders</button>
        <div id="chatkaraResult" class="log"></div>
    </div>

    <div class="debug-section">
        <h3>4. Test POS Dashboard Query</h3>
        <button onclick="testPOSQuery()">Test POS Query</button>
        <div id="posQueryResult" class="log"></div>
    </div>

    <script>
        // You'll need to replace these with your actual Supabase credentials
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        // For now, we'll use the browser's existing Supabase client if available
        const supabase = window.supabase || null;

        function log(message, elementId) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            element.textContent = (element.textContent || '') + logMessage + '\n';
        }

        async function checkAllCafes() {
            const resultDiv = document.getElementById('cafesResult');
            resultDiv.textContent = 'Checking all cafes...\n';
            
            if (!supabase) {
                log('‚ùå Supabase client not available. Please check your setup.', 'cafesResult');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('cafes')
                    .select('id, name, slug, is_active')
                    .order('name');

                if (error) {
                    log(`‚ùå Error fetching cafes: ${error.message}`, 'cafesResult');
                } else {
                    log(`‚úÖ Found ${data.length} cafes:`, 'cafesResult');
                    data.forEach(cafe => {
                        log(`  - ${cafe.name} (ID: ${cafe.id}, Active: ${cafe.is_active})`, 'cafesResult');
                    });
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'cafesResult');
            }
        }

        async function checkAllOrders() {
            const resultDiv = document.getElementById('ordersResult');
            resultDiv.textContent = 'Checking all orders...\n';
            
            if (!supabase) {
                log('‚ùå Supabase client not available.', 'ordersResult');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select(`
                        id,
                        order_number,
                        status,
                        total_amount,
                        created_at,
                        cafe_id,
                        cafes(name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    log(`‚ùå Error fetching orders: ${error.message}`, 'ordersResult');
                } else {
                    log(`‚úÖ Found ${data.length} recent orders:`, 'ordersResult');
                    data.forEach(order => {
                        log(`  - ${order.order_number} (${order.cafes?.name || 'Unknown Cafe'}) - ${order.status} - ‚Çπ${order.total_amount}`, 'ordersResult');
                    });
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'ordersResult');
            }
        }

        async function checkChatkaraOrders() {
            const resultDiv = document.getElementById('chatkaraResult');
            resultDiv.textContent = 'Checking Chatkara orders...\n';
            
            if (!supabase) {
                log('‚ùå Supabase client not available.', 'chatkaraResult');
                return;
            }

            try {
                // First get Chatkara's cafe_id
                const { data: cafes, error: cafeError } = await supabase
                    .from('cafes')
                    .select('id, name')
                    .ilike('name', '%chatkara%');

                if (cafeError) {
                    log(`‚ùå Error fetching Chatkara cafe: ${cafeError.message}`, 'chatkaraResult');
                    return;
                }

                if (cafes.length === 0) {
                    log('‚ùå No cafe found with name containing "chatkara"', 'chatkaraResult');
                    return;
                }

                const chatkaraCafe = cafes[0];
                log(`‚úÖ Found Chatkara cafe: ${chatkaraCafe.name} (ID: ${chatkaraCafe.id})`, 'chatkaraResult');

                // Now get orders for this cafe
                const { data: orders, error: orderError } = await supabase
                    .from('orders')
                    .select(`
                        id,
                        order_number,
                        status,
                        total_amount,
                        created_at,
                        user_id
                    `)
                    .eq('cafe_id', chatkaraCafe.id)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (orderError) {
                    log(`‚ùå Error fetching Chatkara orders: ${orderError.message}`, 'chatkaraResult');
                } else {
                    log(`‚úÖ Found ${orders.length} orders for Chatkara:`, 'chatkaraResult');
                    orders.forEach(order => {
                        log(`  - ${order.order_number} - ${order.status} - ‚Çπ${order.total_amount} - ${order.created_at}`, 'chatkaraResult');
                    });
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'chatkaraResult');
            }
        }

        async function testPOSQuery() {
            const resultDiv = document.getElementById('posQueryResult');
            resultDiv.textContent = 'Testing POS dashboard query...\n';
            
            if (!supabase) {
                log('‚ùå Supabase client not available.', 'posQueryResult');
                return;
            }

            try {
                // This simulates the query that the POS dashboard should be running
                const { data, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        user:profiles(full_name, phone, block, email),
                        cafe:cafes(name, description),
                        order_items(
                            id,
                            menu_item_id,
                            quantity,
                            unit_price,
                            total_price,
                            special_instructions,
                            menu_item:menu_items(name, description)
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    log(`‚ùå POS query error: ${error.message}`, 'posQueryResult');
                } else {
                    log(`‚úÖ POS query successful: ${data.length} orders`, 'posQueryResult');
                    data.forEach(order => {
                        log(`  - ${order.order_number} (${order.cafe?.name || 'Unknown'}) - ${order.status}`, 'posQueryResult');
                    });
                }
            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'posQueryResult');
            }
        }

        // Initialize
        log('Debug POS Orders initialized', 'cafesResult');
        log('Click the buttons above to debug the order display issue', 'cafesResult');
    </script>
</body>
</html>
